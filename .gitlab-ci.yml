# GitLab CI/CD Pipeline for PixEcom
# This pipeline runs tests, builds, and deploys the application

image: node:20

stages:
  - install
  - test
  - build
  - deploy

variables:
  PNPM_VERSION: "9.15.0"
  FF_USE_FASTZIP: "true"
  CACHE_COMPRESSION_LEVEL: "fast"

# Cache dependencies for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - node_modules/
    - apps/*/node_modules/
    - packages/*/node_modules/

###################
# INSTALL STAGE
###################

install_dependencies:
  stage: install
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
    - pnpm config set store-dir .pnpm-store
  script:
    - echo "Installing dependencies..."
    - pnpm install --frozen-lockfile
    - echo "Dependencies installed successfully"
  artifacts:
    paths:
      - node_modules/
      - apps/*/node_modules/
      - packages/*/node_modules/
      - .pnpm-store/
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags

###################
# TEST STAGE
###################

lint:
  stage: test
  needs: [install_dependencies]
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
  script:
    - echo "Running linter..."
    - pnpm lint
    - echo "Linting completed successfully"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'

type_check:
  stage: test
  needs: [install_dependencies]
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
  script:
    - echo "Generating Prisma Client..."
    - pnpm db:generate
    - echo "Running type check..."
    - pnpm turbo run type-check
    - echo "Type check completed successfully"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'

test:
  stage: test
  needs: [install_dependencies]
  services:
    - name: postgres:16-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    POSTGRES_DB: pixecom_test
    POSTGRES_USER: pixecom
    POSTGRES_PASSWORD: pixecom_test
    POSTGRES_HOST_AUTH_METHOD: trust
    DATABASE_URL: postgresql://pixecom:pixecom_test@postgres:5432/pixecom_test
    REDIS_URL: redis://redis:6379
    JWT_SECRET: test-secret-key-for-ci-cd-pipeline
    JWT_REFRESH_SECRET: test-refresh-secret-key-for-ci-cd
    NODE_ENV: test
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
  script:
    - echo "Generating Prisma Client..."
    - pnpm db:generate
    - echo "Setting up test database..."
    - pnpm db:push
    - echo "Running tests..."
    - pnpm test || echo "Tests not yet implemented"
    - echo "Tests completed"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'
  allow_failure: true

security_audit:
  stage: test
  needs: [install_dependencies]
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
  script:
    - echo "Running security audit..."
    - pnpm audit --audit-level=moderate || echo "Security issues found, please review"
    - echo "Security audit completed"
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'

###################
# BUILD STAGE
###################

build:
  stage: build
  needs: [install_dependencies]
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
  script:
    - echo "Generating Prisma Client..."
    - pnpm db:generate
    - echo "Building all packages..."
    - pnpm build
    - echo "Build completed successfully"
  artifacts:
    paths:
      - apps/api/dist/
      - apps/web/.next/
      - apps/api/node_modules/.prisma/
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'

###################
# DEPLOY STAGE
###################

deploy_cloudflare_production:
  stage: deploy
  needs: [build]
  image: node:20
  before_script:
    - npm install -g wrangler pnpm@${PNPM_VERSION}
  script:
    - echo "Deploying to Cloudflare Pages (Production)..."
    - cd apps/web
    - wrangler pages deploy .next --project-name=pixecom-web --branch=main
    - echo "Deployment to Cloudflare Pages completed successfully"
  environment:
    name: production
    url: https://pixecom-web.pages.dev
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
  only:
    - main
    - master

deploy_cloudflare_preview:
  stage: deploy
  needs: [build]
  image: node:20
  before_script:
    - npm install -g wrangler pnpm@${PNPM_VERSION}
  script:
    - echo "Deploying to Cloudflare Pages (Preview)..."
    - cd apps/web
    - wrangler pages deploy .next --project-name=pixecom-web --branch=preview
    - echo "Preview deployment completed successfully"
  environment:
    name: preview
    url: https://preview.pixecom-web.pages.dev
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  only:
    - develop

###################
# OPTIONAL JOBS
###################

# Docker build test (optional - doesn't push)
docker_build_test:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
  script:
    - echo "Building API Docker image..."
    - docker build -f apps/api/Dockerfile -t pixecom-api:${CI_COMMIT_SHORT_SHA} .
    - echo "Building Web Docker image..."
    - docker build -f apps/web/Dockerfile -t pixecom-web:${CI_COMMIT_SHORT_SHA} .
    - echo "Docker images built successfully"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
      when: manual
  allow_failure: true

# Database migration check
migration_check:
  stage: test
  needs: [install_dependencies]
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: pixecom_migration_test
    POSTGRES_USER: pixecom
    POSTGRES_PASSWORD: pixecom_test
    DATABASE_URL: postgresql://pixecom:pixecom_test@postgres:5432/pixecom_migration_test
  before_script:
    - npm install -g pnpm@${PNPM_VERSION}
  script:
    - echo "Testing database migrations..."
    - pnpm db:generate
    - pnpm db:push
    - echo "Database migrations validated successfully"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - apps/api/src/prisma/schema.prisma
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master"'
      changes:
        - apps/api/src/prisma/schema.prisma

# Performance check for frontend
lighthouse_audit:
  stage: test
  image: cypress/browsers:node20.11.0-chrome121.0.6167.85-1-ff120.0-edge121.0.2277.83-1
  needs: [build]
  before_script:
    - npm install -g @lhci/cli@0.12.x
  script:
    - echo "Running Lighthouse audit..."
    - lhci autorun || echo "Lighthouse audit completed with warnings"
  artifacts:
    paths:
      - .lighthouseci/
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
      when: manual
  allow_failure: true
