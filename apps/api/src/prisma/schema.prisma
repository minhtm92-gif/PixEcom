generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── AUTH & USERS ──────────────────────────────────

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  displayName  String   @map("display_name") @db.VarChar(255)
  avatarUrl    String?  @map("avatar_url") @db.VarChar(500)
  isActive     Boolean  @default(true) @map("is_active")
  isSuperadmin Boolean  @default(false) @map("is_superadmin")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  memberships      Membership[]
  refreshTokens    RefreshToken[]
  createdReviews   ProductReview[]          @relation("ReviewCreator")
  createdPreviews  SellpagePreviewToken[]
  sellerSellpages  Sellpage[]               @relation("SellerSellpages")
  sellerAnalytics  SellerAnalytics[]
  utmCampaigns     UtmCampaign[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ─── WORKSPACES & MEMBERSHIP ───────────────────────

model Workspace {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(100)
  logoUrl   String?  @map("logo_url") @db.VarChar(500)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  memberships      Membership[]
  generalSettings  GeneralSettings?
  stores           Store[]
  products         Product[]
  legalPolicies    LegalPolicy[]
  paymentProviders PaymentProvider[]
  orders           Order[]
  productReviews   ProductReview[]
  utmCampaigns     UtmCampaign[]

  @@map("workspaces")
}

enum MemberRole {
  OWNER
  ADMIN
  SELLER
  EDITOR
  VIEWER

  @@map("member_role")
}

model Membership {
  id          String     @id @default(uuid()) @db.Uuid
  workspaceId String     @map("workspace_id") @db.Uuid
  userId      String     @map("user_id") @db.Uuid
  role        MemberRole @default(EDITOR)
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId], name: "uq_membership_ws_user")
  @@index([workspaceId])
  @@index([userId])
  @@map("memberships")
}

// ─── GENERAL SETTINGS ──────────────────────────────

model GeneralSettings {
  id                String   @id @default(uuid()) @db.Uuid
  workspaceId       String   @unique @map("workspace_id") @db.Uuid
  brandName         String?  @map("brand_name") @db.VarChar(255)
  defaultCurrency   String   @default("USD") @map("default_currency") @db.VarChar(3)
  timezone          String   @default("UTC") @db.VarChar(64)
  supportEmail      String?  @map("support_email") @db.VarChar(255)
  supportPhone      String?  @map("support_phone") @db.VarChar(50)
  logoUrl           String?  @map("logo_url") @db.VarChar(500)
  faviconUrl        String?  @map("favicon_url") @db.VarChar(500)
  metaPixelId       String?  @map("meta_pixel_id") @db.VarChar(100)
  googleAnalyticsId String?  @map("google_analytics_id") @db.VarChar(100)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("general_settings")
}

// ─── STORES ────────────────────────────────────────

model Store {
  id                  String   @id @default(uuid()) @db.Uuid
  workspaceId         String   @map("workspace_id") @db.Uuid
  legalSetId          String?  @map("legal_set_id") @db.Uuid
  name                String   @db.VarChar(255)
  slug                String   @db.VarChar(100)
  primaryDomain       String   @map("primary_domain") @db.VarChar(255)
  logoUrl             String?  @map("logo_url") @db.VarChar(500)
  faviconUrl          String?  @map("favicon_url") @db.VarChar(500)
  brandColor          String?  @map("brand_color") @db.VarChar(7)
  currency            String   @default("USD") @db.VarChar(3)
  homepageTitle       String?  @map("homepage_title") @db.VarChar(255)
  homepageDescription String?  @map("homepage_description") @db.Text
  homepageConfig      Json     @default("[]") @map("homepage_config")
  themeConfig         Json     @default("{}") @map("theme_config")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace          Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  legalSet           LegalSet?             @relation("StoreLegalSet", fields: [legalSetId], references: [id], onDelete: SetNull)
  sellpages          Sellpage[]
  storePolicies      StorePolicy[]
  orders             Order[]
  domains            StoreDomain[]
  emailProviders     EmailProviderConfig[]
  emailTemplates     EmailTemplate[]
  emailAutomations   EmailAutomation[]
  emailMessages      EmailMessage[]
  emailSubscriptions EmailSubscription[]

  @@unique([workspaceId, slug], name: "uq_store_slug")
  @@unique([workspaceId, primaryDomain], name: "uq_store_domain")
  @@index([workspaceId])
  @@index([legalSetId])
  @@map("stores")
}

enum DomainVerificationMethod {
  TXT
  A_RECORD

  @@map("domain_verification_method")
}

enum DomainStatus {
  PENDING
  VERIFIED
  FAILED

  @@map("domain_status")
}

enum SslStatus {
  NONE
  PROVISIONING
  ACTIVE
  FAILED

  @@map("ssl_status")
}

model StoreDomain {
  id              String                   @id @default(uuid()) @db.Uuid
  storeId         String                   @map("store_id") @db.Uuid
  hostname        String                   @db.VarChar(255)
  verificationMethod DomainVerificationMethod @default(TXT) @map("verification_method")
  verificationToken  String                @unique @map("verification_token") @db.VarChar(100)
  expectedARecordIp  String?               @map("expected_a_record_ip") @db.VarChar(45)
  status          DomainStatus             @default(PENDING)
  lastCheckedAt   DateTime?                @map("last_checked_at") @db.Timestamptz
  verifiedAt      DateTime?                @map("verified_at") @db.Timestamptz
  failureReason   String?                  @map("failure_reason") @db.Text
  isPrimary       Boolean                  @default(false) @map("is_primary")
  isActive        Boolean                  @default(true) @map("is_active")
  sslStatus       SslStatus                @default(NONE) @map("ssl_status")
  sslProvisionedAt DateTime?               @map("ssl_provisioned_at") @db.Timestamptz
  sslExpiresAt    DateTime?                @map("ssl_expires_at") @db.Timestamptz
  sslError        String?                  @map("ssl_error") @db.Text
  createdAt       DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, hostname], name: "uq_store_domain_hostname")
  @@index([storeId])
  @@index([status])
  @@index([sslStatus])
  @@map("store_domains")
}

// ─── PRODUCTS ──────────────────────────────────────

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED

  @@map("product_status")
}

model Product {
  id                String        @id @default(uuid()) @db.Uuid
  workspaceId       String        @map("workspace_id") @db.Uuid
  name              String        @db.VarChar(255)
  slug              String        @db.VarChar(100)
  basePrice         Decimal       @map("base_price") @db.Decimal(10, 2)
  compareAtPrice    Decimal?      @map("compare_at_price") @db.Decimal(10, 2)
  costPrice         Decimal?      @map("cost_price") @db.Decimal(10, 2)
  currency          String        @default("USD") @db.VarChar(3)
  sku               String?       @db.VarChar(100)
  description       String?       @db.Text
  descriptionBlocks Json          @default("[]") @map("description_blocks")
  shippingInfo      Json          @default("{}") @map("shipping_info")
  tags              Json          @default("[]")
  status            ProductStatus @default(DRAFT)
  createdBy         String?       @map("created_by") @db.Uuid
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace  Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  variants   ProductVariant[]
  media      ProductMedia[]
  sellpages  Sellpage[]
  orderItems OrderItem[]
  reviews    ProductReview[]

  @@unique([workspaceId, slug], name: "uq_product_slug")
  @@index([workspaceId])
  @@map("products")
}

model ProductVariant {
  id             String   @id @default(uuid()) @db.Uuid
  productId      String   @map("product_id") @db.Uuid
  name           String   @db.VarChar(255)
  sku            String?  @db.VarChar(100)
  priceOverride  Decimal? @map("price_override") @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  options        Json     @default("{}")
  stockQuantity  Int      @default(0) @map("stock_quantity")
  isActive       Boolean  @default(true) @map("is_active")
  position       Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([productId])
  @@map("product_variants")
}

model ProductMedia {
  id           String   @id @default(uuid()) @db.Uuid
  productId    String   @map("product_id") @db.Uuid
  url          String   @db.VarChar(1000)
  altText      String?  @map("alt_text") @db.VarChar(255)
  mediaType    String   @default("image") @map("media_type") @db.VarChar(20)
  position     Int      @default(0)
  displayOrder Int      @default(0) @map("display_order")
  isPrimary    Boolean  @default(false) @map("is_primary")
  fileSize     Int?     @map("file_size")
  width        Int?
  height       Int?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, position])
  @@map("product_media")
}

model ProductReview {
  id                String   @id @default(uuid()) @db.Uuid
  workspaceId       String   @map("workspace_id") @db.Uuid
  productId         String   @map("product_id") @db.Uuid
  authorName        String   @map("author_name") @db.VarChar(255)
  avatarUrl         String?  @map("avatar_url") @db.VarChar(500)
  rating            Int
  body              String   @db.Text
  isVisible         Boolean  @default(true) @map("is_visible")
  createdAtOverride DateTime? @map("created_at_override") @db.Timestamptz
  createdBy         String   @map("created_by") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  creator   User      @relation("ReviewCreator", fields: [createdBy], references: [id])

  @@index([workspaceId])
  @@index([productId])
  @@index([productId, isVisible])
  @@map("product_reviews")
}

// ─── SELLPAGES ─────────────────────────────────────

enum SellpageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@map("sellpage_status")
}

model SellpageTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  category    String   @db.VarChar(50) // "minimal", "high-converting", "affiliate", etc.
  thumbnail   String   @db.VarChar(500)

  // Template configuration
  sections     Json    @default("[]")
  headerConfig Json    @default("{}") @map("header_config")
  footerConfig Json    @default("{}") @map("footer_config")
  themeConfig  Json    @default("{}") @map("theme_config")

  isActive    Boolean  @default(true) @map("is_active")
  isFeatured  Boolean  @default(false) @map("is_featured")
  usageCount  Int      @default(0) @map("usage_count")

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([category])
  @@index([isFeatured])
  @@map("sellpage_templates")
}

model Sellpage {
  id                  String         @id @default(uuid()) @db.Uuid
  workspaceId         String         @map("workspace_id") @db.Uuid
  storeId             String         @map("store_id") @db.Uuid
  productId           String         @map("product_id") @db.Uuid
  slug                String         @db.VarChar(100)
  subdomain           String?        @db.VarChar(100)
  customDomain        String?        @map("custom_domain") @db.VarChar(255)
  sellpageDomain      String?        @map("sellpage_domain") @db.VarChar(255)
  status              SellpageStatus @default(DRAFT)
  titleOverride       String?        @map("title_override") @db.VarChar(255)
  descriptionOverride String?        @map("description_override") @db.Text
  seoTitle            String?        @map("seo_title") @db.VarChar(255)
  seoDescription      String?        @map("seo_description") @db.Text
  seoOgImage          String?        @map("seo_og_image") @db.VarChar(500)
  sections            Json           @default("[]")
  headerConfig        Json           @default("{}") @map("header_config")
  footerConfig        Json           @default("{}") @map("footer_config")
  boostModules        Json           @default("[]") @map("boost_modules")
  discountRules       Json           @default("[]") @map("discount_rules")

  // Tracking pixels
  facebookPixelId     String?        @map("facebook_pixel_id") @db.VarChar(100)
  tiktokPixelId       String?        @map("tiktok_pixel_id") @db.VarChar(100)
  googleAnalyticsId   String?        @map("google_analytics_id") @db.VarChar(100)
  googleTagManagerId  String?        @map("google_tag_manager_id") @db.VarChar(100)

  assignedTo          String?        @map("assigned_to") @db.Uuid
  createdBy           String?        @map("created_by") @db.Uuid
  createdAt           DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  store            Store                  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product          Product                @relation(fields: [productId], references: [id], onDelete: Restrict)
  seller           User?                  @relation("SellerSellpages", fields: [assignedTo], references: [id], onDelete: SetNull)
  orders           Order[]
  previewTokens    SellpagePreviewToken[]
  sellerAnalytics  SellerAnalytics[]
  analyticsEvents  AnalyticsEvent[]

  @@unique([storeId, slug], name: "uq_sellpage_slug")
  @@index([workspaceId])
  @@index([storeId])
  @@index([assignedTo])
  @@map("sellpages")
}

model SellpagePreviewToken {
  id         String   @id @default(uuid()) @db.Uuid
  sellpageId String   @map("sellpage_id") @db.Uuid
  tokenHash  String   @unique @map("token_hash") @db.VarChar(255)
  expiresAt  DateTime @map("expires_at") @db.Timestamptz
  createdBy  String   @map("created_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  sellpage Sellpage @relation(fields: [sellpageId], references: [id], onDelete: Cascade)
  creator  User     @relation(fields: [createdBy], references: [id])

  @@index([sellpageId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sellpage_preview_tokens")
}

// ─── CART ──────────────────────────────────────────

model Cart {
  id             String    @id @default(uuid()) @db.Uuid
  sessionId      String    @unique @map("session_id") @db.VarChar(255)
  storeId        String?   @map("store_id") @db.Uuid
  customerEmail  String?   @map("customer_email") @db.VarChar(255)
  lastActivityAt DateTime  @default(now()) @map("last_activity_at") @db.Timestamptz
  expiresAt      DateTime  @map("expires_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  items       CartItem[]
  abandonment CartAbandonment?

  @@index([sessionId])
  @@index([storeId])
  @@index([customerEmail])
  @@index([lastActivityAt])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid()) @db.Uuid
  cartId    String   @map("cart_id") @db.Uuid
  variantId String   @map("variant_id") @db.Uuid
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, variantId], name: "uq_cart_item")
  @@map("cart_items")
}

// ─── ORDERS ────────────────────────────────────────

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED

  @@map("order_status")
}

model Order {
  id              String      @id @default(uuid()) @db.Uuid
  workspaceId     String      @map("workspace_id") @db.Uuid
  storeId         String?     @map("store_id") @db.Uuid
  sellpageId      String?     @map("sellpage_id") @db.Uuid
  orderNumber     String      @map("order_number") @db.VarChar(50)
  customerEmail   String      @map("customer_email") @db.VarChar(255)
  customerName    String?     @map("customer_name") @db.VarChar(255)
  customerPhone   String?     @map("customer_phone") @db.VarChar(50)
  shippingAddress Json        @default("{}") @map("shipping_address")
  subtotal        Decimal     @default(0) @db.Decimal(10, 2)
  shippingCost    Decimal     @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  taxAmount       Decimal     @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount  Decimal     @default(0) @map("discount_amount") @db.Decimal(10, 2)
  total           Decimal     @default(0) @db.Decimal(10, 2)
  currency        String      @default("USD") @db.VarChar(3)
  status          OrderStatus @default(PENDING)
  trackingNumber  String?     @map("tracking_number") @db.VarChar(255)
  trackingUrl     String?     @map("tracking_url") @db.VarChar(1000)
  notes           String?     @db.Text
  paymentMethod   String?     @map("payment_method") @db.VarChar(50)
  paymentId       String?     @map("payment_id") @db.VarChar(255)
  paidAt          DateTime?   @map("paid_at") @db.Timestamptz
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace      Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  store          Store?            @relation(fields: [storeId], references: [id], onDelete: SetNull)
  sellpage       Sellpage?         @relation(fields: [sellpageId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  emailMessages   EmailMessage[]
  recoveredCarts  CartAbandonment[]
  analyticsEvents AnalyticsEvent[]

  @@unique([workspaceId, orderNumber], name: "uq_order_number")
  @@index([workspaceId])
  @@index([storeId])
  @@index([customerEmail])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid()) @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  productId   String?  @map("product_id") @db.Uuid
  variantId   String?  @map("variant_id") @db.Uuid
  productName String   @map("product_name") @db.VarChar(255)
  variantName String?  @map("variant_name") @db.VarChar(255)
  sku         String?  @db.VarChar(100)
  quantity    Int      @default(1)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  lineTotal   Decimal  @map("line_total") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@map("order_items")
}

// ─── PAYMENTS ──────────────────────────────────────

model PaymentProvider {
  id             String   @id @default(uuid()) @db.Uuid
  workspaceId    String   @map("workspace_id") @db.Uuid
  providerType   String   @map("provider_type") @db.VarChar(50)
  displayName    String   @map("display_name") @db.VarChar(255)
  credentialsEnc String   @map("credentials_enc") @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("payment_providers")
}

// ─── LEGAL ─────────────────────────────────────────

model LegalSet {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  policies LegalPolicy[]
  stores   Store[]       @relation("StoreLegalSet")

  @@index([workspaceId])
  @@map("legal_sets")
}

model LegalPolicy {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  legalSetId  String?  @map("legal_set_id") @db.Uuid
  title       String   @db.VarChar(255)
  slug        String   @db.VarChar(100)
  policyType  String   @map("policy_type") @db.VarChar(50)
  bodyHtml    String   @map("body_html") @db.Text
  displayOrder Int     @default(0) @map("display_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  legalSet      LegalSet?     @relation(fields: [legalSetId], references: [id], onDelete: Cascade)
  storePolicies StorePolicy[]

  @@unique([workspaceId, legalSetId, slug], name: "uq_legal_policy_slug")
  @@index([workspaceId])
  @@index([legalSetId])
  @@map("legal_policies")
}

model StorePolicy {
  id           String @id @default(uuid()) @db.Uuid
  storeId      String @map("store_id") @db.Uuid
  policyId     String @map("policy_id") @db.Uuid
  displayOrder Int    @default(0) @map("display_order")

  store  Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  policy LegalPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([storeId, policyId], name: "uq_store_policy")
  @@map("store_policies")
}

// ─── EMAIL SYSTEM ──────────────────────────────────────

enum EmailProviderType {
  SMTP
  SENDGRID
  MAILGUN

  @@map("email_provider_type")
}

enum EmailTemplateType {
  ORDER_CONFIRMATION
  ABANDONED_CART_1H
  ABANDONED_CART_24H
  ABANDONED_CART_7D
  SHIPPING_CONFIRMATION
  DELIVERY_CONFIRMATION

  @@map("email_template_type")
}

enum EmailMessageStatus {
  PENDING
  SENDING
  SENT
  FAILED
  BOUNCED
  CANCELLED

  @@map("email_message_status")
}

model EmailProviderConfig {
  id             String            @id @default(uuid()) @db.Uuid
  storeId        String            @map("store_id") @db.Uuid
  providerType   EmailProviderType @map("provider_type")
  fromEmail      String            @map("from_email") @db.VarChar(255)
  fromName       String?           @map("from_name") @db.VarChar(255)
  replyToEmail   String?           @map("reply_to_email") @db.VarChar(255)
  credentialsEnc String            @map("credentials_enc") @db.Text
  isActive       Boolean           @default(true) @map("is_active")
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, providerType])
  @@index([storeId, isActive])
  @@map("email_provider_configs")
}

model EmailTemplate {
  id           String            @id @default(uuid()) @db.Uuid
  storeId      String            @map("store_id") @db.Uuid
  templateType EmailTemplateType @map("template_type")
  subject      String            @db.VarChar(500)
  bodyHtml     String            @map("body_html") @db.Text
  bodyText     String?           @map("body_text") @db.Text
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, templateType])
  @@index([storeId, isActive])
  @@map("email_templates")
}

model EmailAutomation {
  id                  String            @id @default(uuid()) @db.Uuid
  storeId             String            @map("store_id") @db.Uuid
  name                String            @db.VarChar(255)
  templateType        EmailTemplateType @map("template_type")
  triggerDelayMinutes Int               @map("trigger_delay_minutes")
  discountCode        String?           @map("discount_code") @db.VarChar(50)
  discountPercentage  Int?              @map("discount_percentage")
  isActive            Boolean           @default(true) @map("is_active")
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, isActive])
  @@index([templateType])
  @@map("email_automations")
}

model CartAbandonment {
  id                String    @id @default(uuid()) @db.Uuid
  cartId            String    @unique @map("cart_id") @db.Uuid
  customerEmail     String    @map("customer_email") @db.VarChar(255)
  recoveryToken     String    @unique @map("recovery_token") @db.VarChar(64)
  recoveryTokenHash String    @unique @map("recovery_token_hash") @db.VarChar(64)
  abandonedAt       DateTime  @map("abandoned_at") @db.Timestamptz
  lastEmailSentAt   DateTime? @map("last_email_sent_at") @db.Timestamptz
  emailsSentCount   Int       @default(0) @map("emails_sent_count")
  isRecovered       Boolean   @default(false) @map("is_recovered")
  recoveredAt       DateTime? @map("recovered_at") @db.Timestamptz
  recoveredOrderId  String?   @map("recovered_order_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  cart  Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [recoveredOrderId], references: [id], onDelete: SetNull)

  @@index([customerEmail])
  @@index([abandonedAt, isRecovered])
  @@index([recoveryTokenHash])
  @@map("cart_abandonments")
}

model EmailMessage {
  id               String             @id @default(uuid()) @db.Uuid
  storeId          String             @map("store_id") @db.Uuid
  recipientEmail   String             @map("recipient_email") @db.VarChar(255)
  subject          String             @db.VarChar(500)
  bodyHtml         String             @map("body_html") @db.Text
  bodyText         String?            @map("body_text") @db.Text
  templateType     EmailTemplateType? @map("template_type")
  relatedOrderId   String?            @map("related_order_id") @db.Uuid
  relatedCartId    String?            @map("related_cart_id") @db.Uuid
  status           EmailMessageStatus @default(PENDING)
  attempts         Int                @default(0)
  lastAttemptAt    DateTime?          @map("last_attempt_at") @db.Timestamptz
  sentAt           DateTime?          @map("sent_at") @db.Timestamptz
  errorMessage     String?            @map("error_message") @db.Text
  providerResponse Json?              @map("provider_response")
  scheduledFor     DateTime           @default(now()) @map("scheduled_for") @db.Timestamptz
  createdAt        DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [relatedOrderId], references: [id], onDelete: SetNull)

  @@index([storeId, status])
  @@index([status, scheduledFor])
  @@index([recipientEmail])
  @@map("email_messages")
}

model EmailSubscription {
  id               String    @id @default(uuid()) @db.Uuid
  storeId          String    @map("store_id") @db.Uuid
  email            String    @db.VarChar(255)
  isUnsubscribed   Boolean   @default(false) @map("is_unsubscribed")
  unsubscribedAt   DateTime? @map("unsubscribed_at") @db.Timestamptz
  unsubscribeToken String    @unique @map("unsubscribe_token") @db.VarChar(64)
  reason           String?   @db.Text
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, email])
  @@index([storeId, email, isUnsubscribed])
  @@map("email_subscriptions")
}

// ─── SELLER ANALYTICS & UTM CAMPAIGNS ─────────────────

model SellerAnalytics {
  id               String   @id @default(uuid()) @db.Uuid
  sellerId         String   @map("seller_id") @db.Uuid
  sellpageId       String   @map("sellpage_id") @db.Uuid
  date             DateTime @db.Date
  views            Int      @default(0)
  addToCart        Int      @default(0) @map("add_to_cart")
  initiateCheckout Int      @default(0) @map("initiate_checkout")
  addPaymentInfo   Int      @default(0) @map("add_payment_info")
  purchases        Int      @default(0)
  revenue          Decimal  @default(0) @db.Decimal(10, 2)

  // UTM tracking
  utmSource        String?  @map("utm_source") @db.VarChar(100)
  utmMedium        String?  @map("utm_medium") @db.VarChar(100)
  utmCampaign      String?  @map("utm_campaign") @db.VarChar(100)
  utmContent       String?  @map("utm_content") @db.VarChar(255)
  utmTerm          String?  @map("utm_term") @db.VarChar(255)

  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  seller           User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellpage         Sellpage @relation(fields: [sellpageId], references: [id], onDelete: Cascade)

  @@index([sellerId, date])
  @@index([sellpageId, date])
  @@index([utmCampaign])
  @@map("seller_analytics")
}

model UtmCampaign {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  sellerId    String   @map("seller_id") @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text

  // UTM parameters
  utmSource   String   @map("utm_source") @db.VarChar(100)
  utmMedium   String   @map("utm_medium") @db.VarChar(100)
  utmCampaign String   @map("utm_campaign") @db.VarChar(100)
  utmContent  String?  @map("utm_content") @db.VarChar(255)
  utmTerm     String?  @map("utm_term") @db.VarChar(255)

  // Campaign settings
  startDate   DateTime? @map("start_date") @db.Timestamptz
  endDate     DateTime? @map("end_date") @db.Timestamptz
  budget      Decimal?  @db.Decimal(10, 2)
  isActive    Boolean   @default(true) @map("is_active")

  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  seller      User      @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([sellerId])
  @@index([utmCampaign])
  @@map("utm_campaigns")
}

enum EventType {
  VIEW_CONTENT
  ADD_TO_CART
  INITIATE_CHECKOUT
  ADD_PAYMENT_INFO
  PURCHASE

  @@map("event_type")
}

model AnalyticsEvent {
  id             String    @id @default(uuid()) @db.Uuid
  sellpageId     String    @map("sellpage_id") @db.Uuid
  eventType      EventType @map("event_type")
  sessionId      String    @map("session_id") @db.VarChar(100)

  // Visitor data
  ipAddress      String?   @map("ip_address") @db.VarChar(45)
  userAgent      String?   @map("user_agent") @db.Text
  country        String?   @db.VarChar(100)
  city           String?   @db.VarChar(100)
  device         String?   @db.VarChar(50)

  // UTM data
  utmSource      String?   @map("utm_source") @db.VarChar(100)
  utmMedium      String?   @map("utm_medium") @db.VarChar(100)
  utmCampaign    String?   @map("utm_campaign") @db.VarChar(100)
  utmContent     String?   @map("utm_content") @db.VarChar(255)
  utmTerm        String?   @map("utm_term") @db.VarChar(255)

  // Event data
  revenue        Decimal?  @db.Decimal(10, 2)
  orderId        String?   @map("order_id") @db.Uuid

  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz

  sellpage       Sellpage  @relation(fields: [sellpageId], references: [id], onDelete: Cascade)
  order          Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([sellpageId, createdAt])
  @@index([sessionId])
  @@index([utmCampaign])
  @@index([eventType, createdAt])
  @@map("analytics_events")
}
